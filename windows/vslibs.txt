# Function to forcefully uninstall a program using MsiExec
function Uninstall-VC++($displayName) {
    $programs = Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | Where-Object { $_.DisplayName -like "*$displayName*" }
    if (!$programs) {
        $programs = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | Where-Object { $_.DisplayName -like "*$displayName*" }
    }
    
    foreach ($program in $programs) {
        $guid = $program.PSChildName
        $name = $program.DisplayName
        Write-Host "Uninstalling $name with GUID $guid ..."
        Start-Process msiexec.exe -ArgumentList "/x $guid /quiet /norestart" -Wait
        Write-Host "$name has been uninstalled."
        
        # Attempt to remove leftover registry entries
        Write-Host "Cleaning up registry entries for $name ..."
        Remove-Item -Path "HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\$guid" -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\$guid" -Force -ErrorAction SilentlyContinue
    }
}

# Function to clean up potential leftover files
function Cleanup-Files($path) {
    if (Test-Path $path) {
        Write-Host "Cleaning up files at $path ..."
        Remove-Item -Path $path -Recurse -Force -ErrorAction SilentlyContinue
    }
}

# List of common Visual C++ Redistributable package names
$vcRedistNames = @(
    "Microsoft Visual C++ 2005",
    "Microsoft Visual C++ 2008",
    "Microsoft Visual C++ 2010",
    "Microsoft Visual C++ 2012",
    "Microsoft Visual C++ 2013",
    "Microsoft Visual C++ 2015",
    "Microsoft Visual C++ 2017",
    "Microsoft Visual C++ 2019",
    "Microsoft Visual C++ 2022"
)

# Uninstall each package
foreach ($name in $vcRedistNames) {
    Uninstall-VC++ $name
}

# Clean up potential leftover files (example paths, adjust as necessary)
$cleanupPaths = @(
    "C:\Program Files (x86)\Microsoft Visual Studio",
    "C:\Program Files\Microsoft Visual Studio",
    "C:\ProgramData\Microsoft Visual Studio",
    "C:\Users\$env:UserName\AppData\Local\Microsoft\VisualStudio",
    "C:\Users\$env:UserName\AppData\Roaming\Microsoft\VisualStudio"
)

foreach ($path in $cleanupPaths) {
    Cleanup-Files $path
}
